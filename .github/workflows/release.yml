name: Build & Release Extension

on:
  push:
    tags:
      - 'v*'

permissions:
  contents: write

jobs:
  build-and-release:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Get version from tag
        id: version
        run: echo "VERSION=${GITHUB_REF_NAME}" >> $GITHUB_OUTPUT

      - name: Build extension packages
        run: bash scripts/build.sh

      - name: Detect prerelease
        id: prerelease
        run: |
          if [[ "${{ steps.version.outputs.VERSION }}" =~ -(pre|alpha|beta|rc)[.-][0-9]+$ ]]; then
            echo "prerelease=true" >> $GITHUB_OUTPUT
          else
            echo "prerelease=false" >> $GITHUB_OUTPUT
          fi

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          name: "GitSyncMarks ${{ steps.version.outputs.VERSION }}"
          prerelease: ${{ steps.prerelease.outputs.prerelease }}
          body: |
            ## GitSyncMarks ${{ steps.version.outputs.VERSION }}

            ### Chrome / Chromium / Edge / Brave

            1. Download `GitSyncMarks-${{ steps.version.outputs.VERSION }}-chrome.zip`
            2. Extract the ZIP
            3. Open `chrome://extensions/`
            4. Enable **Developer mode** (toggle in the top right)
            5. Click **Load unpacked**
            6. Select the extracted folder

            ### Firefox

            1. Download `GitSyncMarks-${{ steps.version.outputs.VERSION }}-firefox.zip`
            2. Open `about:debugging#/runtime/this-firefox`
            3. Click **Load Temporary Add-on...**
            4. Select the ZIP file or the `manifest.json` inside the extracted folder

            More info: [README](https://github.com/${{ github.repository }}/blob/main/README.md)
          files: |
            build/GitSyncMarks-${{ steps.version.outputs.VERSION }}-chrome.zip
            build/GitSyncMarks-${{ steps.version.outputs.VERSION }}-firefox.zip
          draft: false
