name: Build & Release Extension

on:
  push:
    tags:
      - 'v*'

permissions:
  contents: write

jobs:
  build-and-release:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          fetch-tags: true

      - name: Get version from tag
        id: version
        run: echo "VERSION=${GITHUB_REF_NAME}" >> $GITHUB_OUTPUT

      - name: Detect prerelease
        id: prerelease
        run: |
          if [[ "${{ steps.version.outputs.VERSION }}" =~ -(pre|alpha|beta|rc)[.-][0-9]+$ ]]; then
            echo "prerelease=true" >> $GITHUB_OUTPUT
          else
            echo "prerelease=false" >> $GITHUB_OUTPUT
          fi

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Install Playwright Chromium
        run: npx playwright install chromium --with-deps

      - name: Build Chrome for E2E
        run: bash scripts/build.sh chrome --no-zip

      - name: Set git user for resetTestRepo
        if: steps.prerelease.outputs.prerelease != 'true'
        run: |
          git config --global user.name "GitSyncMarks CI"
          git config --global user.email "ci@gitsyncmarks.local"

      - name: Run E2E tests (smoke only)
        if: steps.prerelease.outputs.prerelease == 'true'
        run: npx playwright test e2e/smoke.spec.js

      - name: Run E2E tests (full suite)
        if: steps.prerelease.outputs.prerelease != 'true'
        env:
          GITSYNCMARKS_TEST_PAT: ${{ secrets.GITSYNCMARKS_TEST_PAT }}
          GITSYNCMARKS_TEST_REPO_OWNER: ${{ vars.GITSYNCMARKS_TEST_REPO_OWNER }}
          GITSYNCMARKS_TEST_REPO: ${{ vars.GITSYNCMARKS_TEST_REPO }}
        run: npx playwright test

      - name: Build extension packages
        run: bash scripts/build.sh

      - name: Generate screenshots
        if: steps.prerelease.outputs.prerelease != 'true'
        run: npm run generate-screenshots

      - name: Determine target branch
        id: branch
        run: |
          TAG="${{ steps.version.outputs.VERSION }}"
          DEFAULT="${{ github.event.repository.default_branch }}"
          if [[ "${{ steps.prerelease.outputs.prerelease }}" == "true" ]]; then
            BRANCH=$(git branch -r --contains "$TAG" 2>/dev/null | grep -E 'origin/(release|develop)/' || true | head -1 | sed 's|origin/||;s/^[[:space:]]*//')
          fi
          BRANCH=${BRANCH:-$DEFAULT}
          echo "branch=$BRANCH" >> $GITHUB_OUTPUT

      - name: Commit and push screenshots
        if: steps.prerelease.outputs.prerelease != 'true'
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          BRANCH="${{ steps.branch.outputs.branch }}"
          git checkout -B "$BRANCH"
          git add store-assets/
          if [[ -n $(git status --porcelain store-assets/) ]]; then
            git commit -m "chore: update store screenshots (${{ steps.version.outputs.VERSION }})"
            git push origin "HEAD:$BRANCH"
          else
            echo "No screenshot changes, skip commit"
          fi

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          name: "GitSyncMarks ${{ steps.version.outputs.VERSION }}"
          prerelease: ${{ steps.prerelease.outputs.prerelease }}
          body: |
            ## GitSyncMarks ${{ steps.version.outputs.VERSION }}

            ### Chrome / Chromium / Edge / Brave

            1. Download `GitSyncMarks-${{ steps.version.outputs.VERSION }}-chrome.zip`
            2. Extract the ZIP
            3. Open `chrome://extensions/`
            4. Enable **Developer mode** (toggle in the top right)
            5. Click **Load unpacked**
            6. Select the extracted folder

            ### Firefox

            1. Download `GitSyncMarks-${{ steps.version.outputs.VERSION }}-firefox.zip`
            2. Open `about:debugging#/runtime/this-firefox`
            3. Click **Load Temporary Add-on...**
            4. Select the ZIP file or the `manifest.json` inside the extracted folder

            More info: [README](https://github.com/${{ github.repository }}/blob/main/README.md)
          files: |
            build/GitSyncMarks-${{ steps.version.outputs.VERSION }}-chrome.zip
            build/GitSyncMarks-${{ steps.version.outputs.VERSION }}-firefox.zip
          draft: false
