name: Add Bookmark

on:
  workflow_dispatch:
    inputs:
      url:
        description: 'Bookmark URL'
        required: true
        type: string
      title:
        description: 'Bookmark title (leave empty to use URL)'
        required: false
        type: string
        default: ''
      base-path:
        description: 'Base folder in repo (must match extension File Path setting)'
        required: false
        type: string
        default: 'bookmarks'
      folder:
        description: 'Root folder (toolbar, other, menu, or mobile)'
        required: false
        type: string
        default: 'toolbar'
      path:
        description: 'Optional subfolder within root (e.g. dev-tools for bookmarks/toolbar/dev-tools/)'
        required: false
        type: string
        default: ''

permissions:
  contents: write

jobs:
  add-bookmark:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Add bookmark file
        env:
          INPUT_URL: ${{ inputs.url }}
          INPUT_TITLE: ${{ inputs.title }}
          INPUT_BASE_PATH: ${{ inputs.base-path }}
          INPUT_FOLDER: ${{ inputs.folder }}
          INPUT_PATH: ${{ inputs.path }}
        run: |
          URL="$INPUT_URL"
          TITLE="$INPUT_TITLE"
          BASE_PATH="$INPUT_BASE_PATH"
          FOLDER="$INPUT_FOLDER"
          SUBFOLDER="$INPUT_PATH"

          # Use URL as title if not provided
          if [ -z "$TITLE" ]; then
            TITLE="$URL"
          fi

          # Build target directory
          TARGET_DIR="${BASE_PATH}/${FOLDER}"
          if [ -n "$SUBFOLDER" ]; then
            TARGET_DIR="${TARGET_DIR}/${SUBFOLDER}"
          fi
          mkdir -p "$TARGET_DIR"

          # Generate a simple filename from the title
          SLUG=$(echo "$TITLE" | tr '[:upper:]' '[:lower:]' | sed 's/[^a-z0-9]/-/g' | sed 's/--*/-/g' | sed 's/^-//;s/-$//' | cut -c1-40)
          FILENAME="${SLUG}.json"

          # Avoid overwriting existing files
          if [ -f "${TARGET_DIR}/${FILENAME}" ]; then
            FILENAME="${SLUG}-$(date +%s).json"
          fi

          # Create the bookmark file
          cat > "${TARGET_DIR}/${FILENAME}" <<BEOF
          {
            "title": $(echo "$TITLE" | python3 -c "import sys,json; print(json.dumps(sys.stdin.read().strip()))"),
            "url": $(echo "$URL" | python3 -c "import sys,json; print(json.dumps(sys.stdin.read().strip()))")
          }
          BEOF

          # Clean up indentation from heredoc
          sed -i 's/^          //' "${TARGET_DIR}/${FILENAME}"

          echo "Created: ${TARGET_DIR}/${FILENAME}"
          cat "${TARGET_DIR}/${FILENAME}"

      - name: Commit and push
        env:
          INPUT_TITLE: ${{ inputs.title }}
          INPUT_URL: ${{ inputs.url }}
        run: |
          git config user.name "GitSyncMarks Bot"
          git config user.email "gitsyncmarks-bot@users.noreply.github.com"
          git add -A
          COMMIT_LABEL="${INPUT_TITLE:-$INPUT_URL}"
          git commit -m "Add bookmark: ${COMMIT_LABEL}"
          git push
